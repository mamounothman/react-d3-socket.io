<!doctype html>
<html>
  <head>
    <title>D3js, React, and Socket.io</title>
    <style>
        circle {
            stroke: red;
            stroke-width: 3px;
        }
        .animated-circle {
            stroke: none;
            stroke-width: 3px;
        }
        path {
            fill: none;
            stroke: #000;
            stroke-width: 3px;
        }
    </style>
  </head>
  <body>
     <div id="app"><a class="start">Start</a></div> 
    <!-- <svg width="1000" height="100">
		<path transform="translate(200, 0)" />
	</svg> -->
    <!-- <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form> -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.js"></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script>
        $(function(){
            var setp = 1;
            $('a.start').click(function(){
                clearInterval(pingInterval);
                transition(setp);
            });

            var socket = io('http://ec2-34-212-134-187.us-west-2.compute.amazonaws.com:9090');
            socket.on('widget:data', function(data){
                var entries = JSON.parse(data.message).Root.BinaryInSet.Entry;
                entries.forEach(function(Entry) {
                    //console.log(Entry.Value);
                    if(Entry.Value == 1) {
                        //console.log(Entry);
                    }
                });
            });

            var pathdata = [
                [[180, 250], [280, 250]], 
                [[280, 250], [380, 250]],
                [[380, 250], [480, 250]],
                [[480, 250], [580, 250]],
                [[580, 250], [680, 250]],
                [[680, 250], [780, 250]]
            ];

            var svg = d3.select("body").append("svg")
                .attr("width", 960)
                .attr("height", 500);

            var paths = svg.selectAll("path")
                .data(pathdata)
                .enter()
                .append("path")
                .attr("d", d3.svg.line())
                .attr("id",function(d, i) { return "path" + i }); // Catmullâ€“Rom
            
            //console.log([].concat.apply([], pathdata));
            // plot path vertices
            svg.selectAll(".point")
                .data([].concat.apply([], pathdata))
                .enter().append("circle")
                .attr("r", 10)
                .attr("fill", "white")
                .attr("stroke", "red")
                .attr("stroke-width", "1px")
                .attr("transform", function(d) { return "translate(" + d + ")"; });
            
            animateSinglePath(paths, 0);


            function animateSinglePath(selection, indexOfAnimated) {
                indexOfAnimated = indexOfAnimated || 0;
                
                // Create circle if doesn't already exist
                // (achived by binding to single element array)
                circle = svg.selectAll('.animated-circle').data([null])
                circle.enter()
                    .append("circle")
                    .attr("class", "animated-circle")
                    .attr("r", 10)
                    .attr("fill", "steelblue")    
                
                selection.each(function(d, i) {
                    if(i == indexOfAnimated) {
                        // In this context, the "this" object is the DOM
                        // element of the path whose index, i equals the
                        // desired indexOfAnimated
                        path = d3.select(this)
                        // For style, make it dashed
                        path.attr('stroke-dasharray', '5, 5')
                        
                        // Move circle to start pos and begin animation
                        console.log('Start animation', i)
                        console.log(d);
                        circle
                            .attr("transform", "translate(" + d[0] + ")")
                            .transition()
                            .duration(2000)
                            .attrTween("transform", translateAlong(path.node()))
                            .each('end', function() {
                                console.log('End animation', i);
                                
                                // For style, revert stroke to non-dashed
                                path.attr('stroke-dasharray', '')
                                
                                // trigger the next animation by calling this
                                // function again
                                animateSinglePath(selection, indexOfAnimated + 1);
                            });
                    }
                });
            }

            function translateAlong(path) {
                var l = path.getTotalLength();
                return function(d, i, a) {
                    return function(t) {
                        console.log(t * l, t, l);
                        var p = path.getPointAtLength(t * l);
                        return "translate(" + p.x + "," + p.y + ")";
                    };
                };
            }

        });
    </script>
  </body>
</html>